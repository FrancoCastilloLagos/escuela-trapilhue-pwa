<div class="dashboard-wrapper fade-in-viewer" (click)="menuOpen = false; notifOpen = false">
  
  <header class="header-main">
    <div class="header-container">
      <div class="header-left-action">
        <button class="btn-back-nav" (click)="volverDashboard()"><span>‚¨Ö</span> VOLVER</button>
      </div>
      
      <div class="logo-wrapper">
        <div class="logo-white-bg">
          <img src="assets/logo-escuela.png" alt="Logo Escuela" class="img-logo">
        </div>
      </div>
      
      <div class="user-profile-pill">
        <div class="notification-wrapper" *ngIf="!esDocente">
          <button class="notif-trigger" (click)="toggleNotifications($event)">
            <span class="bell-icon">üîî</span>
            <span class="notif-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
          </button>
          
          <div class="notif-dropdown" *ngIf="notifOpen" (click)="$event.stopPropagation()">
            <div class="notif-header">NOTIFICACIONES</div>
            <div class="notif-list">
              <div *ngIf="listaNotificaciones.length === 0" class="no-notif">No hay avisos nuevos</div>
              <div class="notif-item" *ngFor="let n of listaNotificaciones" [class.unread]="!n.leida">
                <div class="notif-indicator" [attr.data-type]="n.tipo"></div>
                <div class="notif-body">
                  <span class="notif-t">{{ n.titulo }}</span>
                  <span class="notif-m">{{ n.mensaje }}</span>
                  <span class="notif-f">{{ n.fecha | date:'HH:mm' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <span class="user-info">{{ userRol }}: {{ userName }}</span>
        
        <button class="menu-trigger" (click)="toggleMenu($event)">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </button>
        
        <div class="dropdown-floating-menu" *ngIf="menuOpen" (click)="$event.stopPropagation()">
          <button class="dropdown-item" (click)="irAConfiguracion()">‚öôÔ∏è Configuraci√≥n</button>
          <button class="dropdown-item" (click)="cerrarSesion()">üö™ Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>
  </header>

  <div class="title-section-container">
    <div class="news-header-badge">ANAL√çTICA DE RENDIMIENTO</div>
  </div>

  <main class="dashboard-body">
    <div class="layout-container">
      <aside class="sidebar-info">
        <div class="glass-card">
          <h3 class="sidebar-title">FILTROS ANAL√çTICOS</h3>
          <div class="selectors-stack">
            <ng-container *ngIf="esDocente">
              <select [(ngModel)]="idCursoSel" (change)="onCursoChange()" class="clean-select-dark">
                <option [ngValue]="null">Seleccione Curso</option>
                <option *ngFor="let c of cursos" [ngValue]="c.id_curso">{{ c.nombre_curso }}</option>
              </select>
              <select [(ngModel)]="idEstudianteSel" (change)="onEstudianteChange()" class="clean-select-dark" [disabled]="!idCursoSel">
                <option [ngValue]="null">Seleccione Estudiante</option>
                <option *ngFor="let e of estudiantes" [ngValue]="e.id_estudiante">{{ e.nombre_completo }}</option>
              </select>
            </ng-container>

            <select [(ngModel)]="idAsignaturaSel" (change)="obtenerDatosGrafico()" class="clean-select-dark" [disabled]="!idEstudianteSel">
              <option [ngValue]="null">Asignatura</option>
              <option *ngFor="let a of asignaturas" [ngValue]="a.id_asignatura">{{ a.nombre }}</option>
            </select>
          </div>

          <div class="analitica-box-glass sumativo" [class.danger-alert]="alertaSumativa">
              <strong>ANAL√çTICA SUMATIVA:</strong><br>{{ mensajeSumativo }}
          </div>
          <div class="analitica-box-glass formativo" [class.danger-alert]="alertaFormativa">
              <strong>PROCESO FORMATIVO:</strong><br>{{ mensajeFormativo }}
          </div>
        </div>
      </aside>

      <section class="news-section">
        <div class="dual-charts-grid">
          <div class="news-display-card">
            <div class="chart-header">CALIFICACIONES SUMATIVAS</div>
            <div class="chart-container-wrapper">
                <canvas #sumativasChart></canvas>
            </div>
          </div>
          <div class="news-display-card">
            <div class="chart-header">DESEMPE√ëO FORMATIVO</div>
            <div class="chart-container-wrapper">
                <canvas #formativasChart></canvas>
            </div>
          </div>
        </div>
        
        <div class="news-display-card table-card" *ngIf="notasActuales.length > 0">
          <div class="table-area">
            <div class="table-title">Historial de Calificaciones</div>
            <div class="table-scroll">
              <table class="minimal-table">
                <thead>
                  <tr><th>EVALUACI√ìN</th><th>VALOR</th><th>TIPO</th></tr>
                </thead>
                <tbody>
                  <tr *ngFor="let n of notasActuales">
                    <td>{{ n.descripcion || n.nombre_evaluacion }}</td>
                    <td [class.red-text]="n.valor < 4.0" class="bold-text">{{ n.valor | number:'1.1-1' }}</td>
                    <td><span class="badge-tipo" [class.sum]="n.tipo?.toUpperCase() !== 'FORMATIVA'">{{ n.tipo || 'Sumativa' }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="minimal-footer">
    <p>Copyright ¬© 2026 | <span>KALINK DISE√ëOS</span></p>
  </footer>
</div>